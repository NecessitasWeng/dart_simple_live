name: app-build-action

# å…è®¸æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) æˆ– æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘
on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  # åªä¿ç•™ iOS å’Œ Mac çš„æ„å»ºä»»åŠ¡
  build-mac-ios:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      # 1. ç­¾å‡ºä»£ç 
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }} # ä½¿ç”¨å½“å‰è§¦å‘çš„åˆ†æ”¯æˆ–æ ‡ç­¾

      # 2. è®¾ç½® JAVA ç¯å¢ƒ (Flutter éœ€è¦)
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: "17"
          cache: 'gradle'

      # 3. è®¾ç½® Flutter
      - name: Flutter action
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          cache: true

      # 4. å¼€å¯ macOS æ¡Œé¢æ”¯æŒ
      - name: Enable Flutter Desktop
        run: flutter config --enable-macos-desktop

      # 5. æ‹‰å–ä¾èµ–åŒ…
      - name: Restore packages
        run: |
          cd simple_live_app
          flutter pub get

      # 6. å®‰è£… Mac æ‰“åŒ…å·¥å…· (è™½ç„¶ä½ åªè¦ iOSï¼Œä½†è„šæœ¬é€šå¸¸è¿å¸¦ Mac ä¸€èµ·æ‰“)
      - name: Install appdmg
        run: npm install -g appdmg

      # 7. å®‰è£… flutter_distributor
      - name: Install flutter_distributor
        run: dart pub global activate flutter_distributor

      # ----------------------------------------------------------------
      # æ ¸å¿ƒæ­¥éª¤ï¼šæ‰“åŒ… iOS IPA (å·²ç§»é™¤å®‰å“éƒ¨åˆ†)
      # ----------------------------------------------------------------
      - name: Build IPA
        run: |
          cd simple_live_app
          # å…³é”®ï¼š--no-codesign è·³è¿‡ç­¾åï¼Œé˜²æ­¢æŠ¥é”™
          flutter build ios --release --no-codesign

      # 8. æ‰‹åŠ¨å‹ç¼© Payload ç”Ÿæˆæœªç­¾åçš„ IPA
      - name: Create IPA
        run: |
          cd simple_live_app
          mkdir build/ios/iphoneos/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/Runner.app
          cd build/ios/iphoneos/
          zip -q -r ios_no_sign.ipa Payload
          cd ../../..

      # 9. ä¸Šä¼  IPA åˆ° GitHub Artifacts (è¿™å°±æ˜¯ä½ è¦ä¸‹è½½çš„æ–‡ä»¶)
      - name: Upload IPA to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: |
            simple_live_app/build/ios/iphoneos/ios_no_sign.ipa

      # ----------------------------------------------------------------
      # ä¸‹é¢æ˜¯ macOS æ‰“åŒ… (å¦‚æœä¸éœ€è¦ Mac ç‰ˆï¼Œå¯ä»¥å¿½ç•¥ï¼Œç•™ç€ä¹Ÿæ— å¦¨)
      # ----------------------------------------------------------------
      - name: Build MacOS
        run: |
          cd simple_live_app
          flutter_distributor package --platform macos --targets dmg,zip --skip-clean

      # ä¸Šä¼  Mac æ–‡ä»¶
      - name: Upload MacOS to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac
          path: |
            simple_live_app/build/dist/*/*.dmg
            simple_live_app/build/dist/*/*.zip

      # ç»“æŸ
      - run: echo "ğŸ iOS Build job finished!"
